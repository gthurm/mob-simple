<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>



        <script src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load('visualization', '1.0', {'packages':['corechart']});</script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.min.js"></script>


        <script id="item-tmpl" type="x-tmpl-mustache">
            <div class="row">
                <div class="col-md-12">{{makeName}} {{modelDescription}}</div>
            </div>
            <div class="row">
                <div class="col-md-6">{{#firstImageUrl}}<img src="http://{{firstImageUrl}}_28.JPG">{{/firstImageUrl}}</div>
                <div class="col-md-6"><h6>{{priceConsumerGross}} EUR</h6></div>
            </div>
        </script>


        <script type="text/javascript">
            $(function() {

                var itemTemplate = $("#item-tmpl").html();
                Mustache.parse(itemTemplate);

                $.ajax({
                    url: "http://m.mobile.de/svc/r/makes/Car",
                })
                .done(function(data) {
                    var options = $("#select-makes");
                    $.each(data.makes, function(index, make) {
                        options.append($("<option />").val(make.i).text(make.n));
                    });
                });

                $.ajax({
                    url: "http://m.mobile.de/svc/r/Car?_lang=en",
                })
                .done(function(data) {
                    renderCheckBox("#form-categories", data.categories, "c");
                    renderCheckBox("#form-fuels", data.fuels, "ft");
                    renderCheckBox("#form-gears", data.gears, "tr");
                    renderCheckBox("#form-colors", data.colors, "ecol");
                    renderRadioBox("#form-climatisations", data.climatisations, "clim");
                });


                $(document).on("change", "#search-form :input", function(event) {
                    var q =  $("#search-form :input").filter(function(index, element) {
                        return $(element).val() != "";
                    }).serializeArray();

                    $.ajax({
                        url: "http://m.mobile.de/svc/s",
                        data: q
                    }).done(function(response) {
                        var result = $("#search-result");
                        result.empty();
                        $.each(response.items, function(index, item) {
                            result.append($("<div />").html(Mustache.render(itemTemplate, item)));
                        });
                    });

                    $.ajax({
                        url: "http://m.mobile.de/svc/s?psz=0&aggs=c,ft,p,pw",
                        data: q
                    }).done(function(response) {
                        var aggs = response.aggregations;
                        // pieChart("c-chart",  "catgeory", aggs.c);
                        // pieChart("ft-chart", "fuel",     aggs.ft);
                        // barChart("p-chart",  "price",    aggs.p);
                        // barChart("pw-chart", "power",    aggs.pw);

                    });
                    event.preventDefault();
                });

                function renderCheckBox(id, values, name) {
                    var options = $(id);
                    $.each(values, function(index, item) {
                        var input = $('<input type="checkbox">').attr("name", name).val(item.i);
                        options.append(
                            $('<div class="checkbox">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)));
                    });
                }

                function renderRadioBox(id, values, name) {
                    var options = $(id);
                    $.each(values, function(index, item) {
                        var input = $('<input type="radio">').attr("name", name).val(item.i);
                        options.append(
                            $('<div class="radio">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)));
                    });
                }

                function pieChart(id, name, values) {
                    var chart = new google.visualization.PieChart(document.getElementById(id));
                    chart.draw(makeTable(name, values, function(v) {
                        return [v.key, v.count];
                    }));
                }

                function barChart(id, name, values) {
                    var chart = new google.visualization.BarChart(document.getElementById(id));
                    chart.draw(makeTable(name, values,  function(v) {
                        var key = Object.keys(v)[0];
                        return [key + "%", v[key]];
                    }));
                }

                function makeTable(name, values, mapFn) {
                    var data = new google.visualization.DataTable();
                    data.addColumn("string", name);
                    data.addColumn("number", "#");
                    data.addRows(values.map(mapFn));
                    return data;
                }

            });
        </script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <form id="search-form">
                        <input type="hidden" name="_raw" value="1">
                        <input type="hidden" name="vc" value="Car">


                        <div>
                            <input type="radio" name="con" value="">Any
                            <input type="radio" name="con" value="USED">Used
                            <input type="radio" name="con" value="NEW">New
                        </div>

                        <div>
                            Make
                            <select name="mk" id="select-makes">
                                <option value="">Any</option>
                            </select>
                        </div>

                        <div>
                            <label for="pw">Power</label>
                            <input id="pw" type="text" name="pw">
                        </div>

                        <div>
                            <label for="p">Price</label>
                            <input id="p" name="p" type="text">
                        </div>

                        <div id="form-categories">
                            Categories
                        </div>

                        <div id="form-fuels">
                            Fuels
                        </div>

                        <div id="form-gears">
                            Gears
                        </div>

                        <div id="form-colors">
                            Exterior colors
                        </div>

                        <div id="form-climatisations">
                            Climatisations
                        </div>
                    </form>
                </div>
                <div class="col-md-8">
                    <div id="charts">
                        <div id="ft-chart"></div>
                        <div id="c-chart"></div>
                        <div id="p-chart"></div>
                        <div id="pw-chart"></div>
                    </div>
                    <div id="search-result" class="container-fluid"></div>
                </div>
            </div>
        </div>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    </body>
</html>