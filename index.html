<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

        <script src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load('visualization', '1.0', {'packages':['corechart']});</script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.min.js"></script>

        <style>
            .popover{
               max-width: 100%;
               width: 320;
            }
        </style>

        <script id="item-tmpl" type="x-tmpl-mustache">
            <div class="row">
                <div class="col-md-10">
                    <strong>{{makeName}} {{modelDescription}}</strong>
                </div>
                <div class="col-md-2">
                    <span class="pull-right"><strong>{{priceConsumerGross}} EUR</strong></span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">{{location.country}}-{{location.zipCode}} {{location.city}}</div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {{#powerKw}}
                    <div{{#fv.pw}} class="text-danger"{{/fv.pw}}>
                        {{powerKw}}kW
                    </div>
                    {{/powerKw}}

                    {{#cubicCapacity}}
                    <div{{#fv.cc}} class="text-danger"{{/fv.cc}}>
                        {{cubicCapacity}}ccm
                    </div>
                    {{/cubicCapacity}}

                    {{#mileage}}
                    <div{{#fv.ml}} class="text-danger"{{/fv.ml}}>
                        {{mileage}}km
                    </div>
                    {{/mileage}}
                </div>
            </div>
        </script>


        <script type="text/javascript">
            var math = (function() {
                return {
                    toArray: function (v) {
                        var key = Object.keys(v)[0];
                        return [key, v[key]];
                    },

                    pmax: function(val, percentiles) {
                        if (!percentiles) return;
                        var max = [0, 0];
                        $.each(percentiles.map(this.toArray), function(i, p) {
                            if (val > max[1] || val >= p[1]) max = p;
                        });
                        return max;
                    },

                    lessThan: function(threshold) {
                        return function (perc) {
                            return perc[0] <= threshold;
                       };
                    },

                    greaterThan: function(threshold) {
                        return function (perc) {
                            return perc[0] >= threshold;
                        };
                    }
                };
            })();


            var charts = (function() {

                var data = {"c":[{"key":"Limousine","count":472429},{"key":"EstateCar","count":287053},{"key":"SmallCar","count":219405},{"key":"OffRoad","count":170982},{"key":"Van","count":168570},{"key":"Cabrio","count":80475},{"key":"SportsCar","count":69134},{"key":"OtherCar","count":28473}]};


                function pieChart(id, name, values) {
                    var chart = new google.visualization.PieChart(document.getElementById(id));
                    chart.draw(makeTable(name, values, function(v) {
                        return [v.key, v.count];
                    }));
                }

                function barChart(id, name, values) {
                    var chart = new google.visualization.BarChart(document.getElementById(id));
                    chart.draw(makeTable(name, values,  function(v) {
                        var key = Object.keys(v)[0];
                        return [key + "%", v[key]];
                    }));
                }

                function makeTable(name, values, mapFn) {
                    var data = new google.visualization.DataTable();
                    data.addColumn("string", name);
                    data.addColumn("number", "#");
                    data.addRows(values.map(mapFn));
                    return data;
                }

                return {

                    setData: function(newData) {
                        data = newData;
                    },

                    // pie charts
                    category: {
                        draw: function() {
                            pieChart("chart-area", "category", data.c);
                        }
                    },
                    gear: {
                        draw: function() {
                            pieChart("chart-area", "gear", data.tr);
                        }
                    },
                    fuel: {
                        draw: function() {
                            pieChart("chart-area", "fuel", data.ft);
                        }
                    },
                    color: {
                        draw: function() {
                            pieChart("chart-area", "color", data.ecol);
                        }
                    },
                    climatisation: {
                        draw: function() {
                            pieChart("chart-area", "Climatisation", data.clim);
                        }
                    },

                    // bar charts
                    power: {
                        draw: function() {
                            barChart("chart-area", "power", data.pw);
                        }
                    },
                    price: {
                        draw: function() {
                            barChart("chart-area", "price", data.p);
                        }
                    },
                    cubicCapacity: {
                        draw: function() {
                            barChart("chart-area", "capacity", data.cc);
                        }
                    }
                }
            })();

            $(function() {

                var itemTemplate = $("#item-tmpl").html();
                Mustache.parse(itemTemplate);

                $.ajax({
                    url: "http://m.mobile.de/svc/r/makes/Car",
                    dataType: "jsonp",
                    cache: true,
                    jsonp: "_jsonp"
                }).done(function(data) {
                    var options = $("#select-makes");
                    $.each(data.makes, function(index, make) {
                        options.append($("<option />").val(make.i).text(make.n));
                    });
                });

                $.ajax({
                    url: "http://m.mobile.de/svc/r/Car?_lang=en",
                    dataType: "jsonp",
                    cache: true,
                    jsonp: "_jsonp"
                }).done(function(data) {
                    render("checkbox", "form-categories", data.categories, "c", "Categories");
                    render("checkbox", "form-fuels", data.fuels, "ft", "Fuels");
                    render("checkbox", "form-gears", data.gears, "tr", "Gears");
                    render("checkbox", "form-colors", data.colors, "ecol", "Colors");
                    render("radio",    "form-climatisations", data.climatisations, "clim", "Climatisations");
                });

                $(document).on("change", "#search-form :input", function(event) {
                    $("#chart-area").empty();
                    doSearch();
                    event.preventDefault();
                });

                doSearch();

                var chartArea = $('<div id="chart-area"></div>');
                $(".chartable").popover({
                    html: true,
                    container: 'body',
                    content: chartArea
                }).on('inserted.bs.popover', function() {
                    var c = $(this).data("chart");
                    charts[c].draw();
                }).on('hidden.bs.popover', function() {
                    $("#chart-area").empty();
                });

                function doSearch() {
                    var q, search, stats;

                    q = $("#search-form :input").filter(function(index, element) {
                                return $(element).val() != "";
                    }).serializeArray();

                    search = $.ajax({
                        url: "http://m.mobile.de/svc/s?psz=20",
                        data: q
                    });

                    stats = $.ajax({
                        url: "http://m.mobile.de/svc/s?psz=0&aggs=c,ft,pw,cc,ml,ecol,tr,clim",
                        data: q
                    });

                    $.when(search, stats).done(function(r1, r2) {
                        handleSearch(r1[0], r2[0]);
                        charts.setData(r2[0].aggregations);
                    });

                    function handleSearch(res, stats) {
                        $("#num-search-results").text(res.numResultsTotal);
                        var div = $("#search-result").empty();

                        $.each(res.items, function(index, item) {
                            item.fv = {
                                pw: mark(item.powerKw, stats.aggregations.pw, math.greaterThan(95)),
                                cc: mark(item.cubicCapacity, stats.aggregations.cc, math.greaterThan(95)),
                                ml: mark(item.mileage, stats.aggregations.ml, math.lessThan(20))
                            }
                            div.append($("<div />").addClass("well").html(Mustache.render(itemTemplate, item)));
                        });
                    }
                }

                function mark(val, percentiles, predicate) {
                    var perc = math.pmax(val, percentiles);
                    if (predicate(perc)) return {
                        p: perc
                    };
                }

                function render(type, id, values, name, label) {
                    var options = $("#" + id);
                    $.each(values, function(index, item) {
                        var input = $('<input type="' + type + '">').attr("name", name).val(item.i);
                        options.append(
                            $('<div class="' + type + '">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)));
                    });
                }
            });
        </script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2">
                    <form id="search-form">
                        <input type="hidden" name="_raw" value="1">
                        <input type="hidden" name="vc" value="Car">

                        <div class="form-group">
                            <input type="radio" name="con" value=""> Any
                            <input type="radio" name="con" value="USED"> Used
                            <input type="radio" name="con" value="NEW"> New
                        </div>

                        <div class="form-group">
                            Make
                            <select name="mk" id="select-makes">
                                <option value="">Any</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="pw">Power</label>
                            <input id="pw" type="text" name="pw">
                        </div>

                        <div class="form-group">
                            <label for="p">Price</label>
                            <input id="p" name="p" type="text">
                        </div>

                        <div id="checkboxes">
                            <div class="form-group">
                                <span class="chartable" data-chart="category">Categories</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-categories" aria-expanded="false"></span>
                                <div class="collapse" id="form-categories" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="fuel">Fuels</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-fuels" aria-expanded="false"></span>
                                <div class="collapse" id="form-fuels" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="climatisation">Climatisation</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-climatisations" aria-expanded="false"></span>
                                <div class="collapse" id="form-climatisations" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="gear">Gears</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-gears" aria-expanded="false"></span>
                                <div class="collapse" id="form-gears" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="color">Colors</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-colors" aria-expanded="false"></span>
                                <div class="collapse" id="form-colors" aria-expanded="false" style="height: 0px;"></div>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="col-md-5">
                    <div id="search-result-head"><h4>Results <span id="num-search-results" class="badge"></span></h4></div>
                    <div id="search-result" class="container-fluid"></div>
                </div>
            </div>
        </div>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    </body>
</html>