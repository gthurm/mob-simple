<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

        <script src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load('visualization', '1.0', {'packages':['corechart']});</script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.min.js"></script>

        <style>
            .popover {
               max-width: 100%;
            }
        </style>

        <script id="item-tmpl" type="x-tmpl-mustache">
            <div class="row">
                <div class="col-md-10">
                    <strong>{{makeName}} {{modelDescription}}</strong>
                </div>
                <div class="col-md-2">
                    <span class="pull-right"><strong>{{priceConsumerGross}} EUR</strong></span>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">{{location.country}}-{{location.zipCode}} {{location.city}}</div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {{#powerKw}}
                    <div{{#fv.pw}} class="text-danger"{{/fv.pw}}>
                        {{.}}&thinsp;kW
                    </div>
                    {{/powerKw}}

                    {{#cubicCapacity}}
                    <div{{#fv.cc}} class="text-danger"{{/fv.cc}}>
                        {{.}}&thinsp;ccm
                    </div>
                    {{/cubicCapacity}}

                    {{#mileage}}
                    <div{{#fv.ml}} class="text-danger"{{/fv.ml}}>
                        {{.}}&thinsp;km
                    </div>
                    {{/mileage}}
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    {{#hist.search}}
                        <span class="label label-success">{{.}}</span>
                    {{/hist.search}}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {{#hist.page}}
                        <span class="label label-info">{{.}}</span>
                    {{/hist.page}}
                </div>
            </div>
        </script>


        <script type="text/javascript">

            var globals = {
                page: {
                    range: [0.0, 40.0],
                    filter: function(p) {
                        return this.range[0] <= p && p <= this.range[1];
                    }
                },

                search: {
                    range: [2.0, 25.0],
                    filter: function(p) {
                        return this.range[0] <= p && p <= this.range[1];
                    }
                }
            };

            var math = (function() {
                return {
                    toArray: function (v) {
                        var key = Object.keys(v)[0];
                        return [key, v[key]];
                    },

                    pmax: function(val, percentiles) {
                        if (!percentiles) return;
                        var max = [0, 0];
                        $.each(percentiles.map(this.toArray), function(i, p) {
                            if (val > max[1] || val >= p[1]) max = p;
                        });
                        return max;
                    },

                    lessThan: function(threshold) {
                        return function (perc) {
                            return perc[0] <= threshold;
                       };
                    },

                    greaterThan: function(threshold) {
                        return function (perc) {
                            return perc[0] >= threshold;
                        };
                    }
                };
            })();


            var charts = (function() {

                var data = {};

                function keyCountData(v) {
                    return [v.key, v.count];
                }

                function mapEntryData(v) {
                    var key = Object.keys(v)[0];
                    return [key + "%", v[key]];
                }

                function pieChart(id, name, values, trFn) {
                    var chart = new google.visualization.PieChart(document.getElementById(id));
                    chart.draw(makeTable(name, values, trFn));
                }

                function barChart(id, name, values, trFn) {
                    var chart = new google.visualization.BarChart(document.getElementById(id));
                    chart.draw(makeTable(name, values, trFn), {
                        width:  400,
                        height: 600,
                    });
                }

                function makeTable(name, values, mapFn) {
                    var data = new google.visualization.DataTable();
                    data.addColumn("string", name);
                    data.addColumn("number", "#");
                    data.addRows(values.map(mapFn));
                    return data;
                }

                return {

                    setData: function(newData) {
                        data = newData;
                    },

                    // pie charts
                    category: {
                        draw: function(dest) {
                            pieChart(dest, "category", data.c, keyCountData);
                        }
                    },
                    gear: {
                        draw: function(dest) {
                            pieChart(dest, "gear", data.tr, keyCountData);
                        }
                    },
                    fuel: {
                        draw: function(dest) {
                            pieChart(dest, "fuel", data.ft, keyCountData);
                        }
                    },
                    color: {
                        draw: function(dest) {
                            pieChart(dest, "color", data.ecol, keyCountData);
                        }
                    },
                    climatisation: {
                        draw: function(dest) {
                            pieChart(dest, "climatisation", data.clim, keyCountData);
                        }
                    },
                    feature: {
                        draw: function(dest) {
                            if (data.fe) {
                                pieChart(dest, "feature", data.fe.slice(-20, -5), keyCountData);
                            }
                        }
                    },

                    // bar charts
                    power: {
                        draw: function(dest) {
                            barChart(dest, "power", data.pw, mapEntryData);
                        }
                    },
                    price: {
                        draw: function(dest) {
                            barChart(dest, "price", data.p, mapEntryData);
                        }
                    },
                    cubicCapacity: {
                        draw: function(dest) {
                            barChart(dest, "capacity", data.cc, mapEntryData);
                        }
                    }
                }
            })();

            var pager = (function() {
                var numResults,
                    ps = 0;

                return {
                    current: function(val) {
                        if (val >= 0) {
                            ps = val;
                        }
                        return ps;
                    },
                    previous: function() {
                        if (ps >= 20) {
                            return ps - 20;
                        }
                    },
                    next: function() {
                        if (ps + 20 < numResults) {
                            return ps + 20;
                        }
                    },
                    update: function(val) {
                        numResults = val;
                    },
                    reset: function() {
                        numResults = undefined;
                        ps = 0;
                    }
                };
            })();

            var pageScope = (function(globals) {
                return {
                    hist: function(items) {
                        var features = {};
                        $.each(items, function(i, it) {
                            $.each(it.features, function(ii, f) {
                                if (features[f] === undefined)
                                    features[f] = 1;
                                else
                                    features[f] += 1;
                            });
                        });

                        var hist = [];
                        $.each(features, function(i, f) {
                            var p = f * 100.0 / items.length;
                            if (globals.page.filter(p)) {
                                hist.push(i);
                            }
                        });
                        return new Set(hist);
                    }
                }
            })(globals);

            function makeSlider(name, scope) {
                var span = $("label[for='" + name + "']").find("span.range");
                $("#" + name).slider({
                    range: true,
                    min: 0,
                    max: 100,
                    values: [scope.range[0], scope.range[1]],
                    slide: function(event, ui) {
                        span.text(ui.values[0] + " - " + ui.values[1]);
                        scope.range[0] = ui.values[0];
                        scope.range[1] = ui.values[1];
                    }
                });
                span.text(scope.range[0] + " - " + scope.range[1]);
            }

            $(function() {

                var sortOrder = "UP";

                var itemTemplate = $("#item-tmpl").html();
                Mustache.parse(itemTemplate);

                $.ajax({
                    url: "//m.mobile.de/svc/r/makes/Car",
                    dataType: "jsonp",
                    cache: true,
                    jsonp: "_jsonp"
                }).done(function(data) {
                    var options = $("#select-makes");
                    $.each(data.makes, function(index, make) {
                        options.append($("<option>").val(make.i).text(make.n));
                    });
                });


                $("#select-makes").on("change", function(e) {
                    var makeId = $(this).val();
                    var options = $("#select-models").empty().append($('<option>').val("").text("Any"));
                    if (makeId != "") {
                        $.ajax({
                            url: "//m.mobile.de/svc/r/models/" + makeId,
                            dataType: "jsonp",
                            cache: true,
                            jsonp: "_jsonp"
                        }).done(function(data) {
                            $.each(data.models, function(index, model) {
                                if (!model.g) {
                                    options.append($("<option>").val(model.i).text(model.n))
                                }
                            });
                        });
                    }
                });

                $.ajax({
                    url: "//m.mobile.de/svc/r/Car?_lang=en",
                    dataType: "jsonp",
                    cache: true,
                    jsonp: "_jsonp"
                }).done(function(data) {
                    render("checkbox", "form-categories", data.categories, "c");
                    render("checkbox", "form-fuels", data.fuels, "ft");
                    render("checkbox", "form-gears", data.gears, "tr");
                    render("checkbox", "form-colors", data.colors, "ecol");
                    render("checkbox", "form-park-assists", [
                        {i: "REAR_SENSORS",  n: "Rear Sensors"},
                        {i: "FRONT_SENSORS", n: "Front Sensors"}], "pa");
                    render("checkbox", "form-features", data.features, "fe");
                    render("radio",    "form-climatisations", data.climatisations, "clim");
                });

                $(document).on("change", "#search-form :input", function(event) {
                    pager.reset();
                    doSearch();
                    event.preventDefault();
                });

                $(".next").on("click", function(e) {
                    if (pager.next() >= 0) {
                        pager.current(pager.next());
                        doSearch();
                    }
                });

                $(".previous").on("click", function(e) {
                    if (pager.previous() >= 0) {
                        pager.current(pager.previous());
                        doSearch();
                    }
                });

                $("#sort-order").on("click", function(e) {
                    if (sortOrder === "UP") {
                        sortOrder = "DOWN";
                        $(this).removeClass("glyphicon-chevron-down");
                        $(this).addClass("glyphicon-chevron-up");
                    } else {
                        sortOrder = "UP";
                        $(this).removeClass("glyphicon-chevron-up");
                        $(this).addClass("glyphicon-chevron-down");
                    }
                    doSearch();
                });

                doSearch();

                var chartArea = $('<div id="chart-area"></div>');
                $(".chartable").popover({
                    html: true,
                    container: 'body',
                    content: chartArea
                }).on('inserted.bs.popover', function() {
                    var c = $(this).data("chart");
                    charts[c].draw("chart-area");
                }).on('hidden.bs.popover', function() {
                    $("#chart-area").empty();
                });


                makeSlider("page-range", globals.page);
                makeSlider("search-range", globals.search);

                function doSearch() {
                    var q, search, stats, isNewCarSearch;

                    q = $("#search-form :input").filter(function(index, element) {
                                return $(element).val() != "";
                    }).serializeArray();

                    isNewCarSearch = q.filter(function(e) {
                        return(e.name === "con" && e.value === 'NEW');
                    }).length == 1;

                    search = $.ajax({
                        url: "//m.mobile.de/svc/s?ps=" + pager.current() + "&od=" + sortOrder,
                        data: q
                    });

                    stats = $.ajax({
                        url: "//m.mobile.de/svc/s?psz=0&aggs=pMin,c,ft,pw,cc,ml,ecol,tr,clim,fe",
                        data: q
                    });

                    $.when(search, stats).done(function(r1, r2) {
                        handleSearch(r1[0], r2[0]);
                        charts.setData(r2[0].aggregations);
                        charts.category.draw('c-chart');
                        charts.fuel.draw('ft-chart');
                        charts.climatisation.draw('clim-chart');
                        charts.gear.draw('gear-chart');
                        charts.color.draw('color-chart');
                    });

                    function handleSearch(res, stats) {
                        pager.update(res.numResultsTotal);

                        if (pager.previous() >= 0) {
                            $(".previous").removeClass("disabled");
                        } else {
                            $(".previous").addClass("disabled");
                        }
                        if (pager.next() >= 0) {
                            $(".next").removeClass("disabled");
                        } else {
                            $(".next").addClass("disabled");
                        }

                        $("#num-search-results").text(res.numResultsTotal);

                        updateAggregations(stats.aggregations.fe,   "#form-features");
                        updateAggregations(stats.aggregations.ecol, "#form-colors");
                        updateAggregations(stats.aggregations.c,    "#form-categories");
                        updateAggregations(stats.aggregations.tr,   "#form-gears");
                        updateAggregations(stats.aggregations.ft,   "#form-fuels");

                        var hist = {
                            search: histogramm(stats.aggregations.fe, res.numResultsTotal),
                            page: pageScope.hist(res.items)
                        };
                        var div = $("#search-result").empty();
                        $.each(res.items, function(index, item) {
                            if (isNewCarSearch)
                                item.features = item.features.filter(function(e) {
                                    return e != 'HU_AU_NEU'
                                        && e != 'FULL_SERVICE_HISTORY'
                                        && e != 'WARRANTY'
                                        && e != 'NONSMOKER_VEHICLE';});

                            item.hist = {
                                search: ofInterest(item.features, hist.search),
                                page: ofInterest(item.features, hist.page)
                            };

                            item.fv = {
                                pw: mark(item.powerKw, stats.aggregations.pw, math.greaterThan(95)),
                                cc: mark(item.cubicCapacity, stats.aggregations.cc, math.greaterThan(95)),
                                ml: mark(item.mileage, stats.aggregations.ml, math.lessThan(20))
                            };
                            div.append($("<div>").addClass("well").html(Mustache.render(itemTemplate, item)));
                        });
                    }
                }

                function updateAggregations(aggs, elementId) {
                    var transformed = toMap(aggs);
                    $(elementId).find("label span").each(function(i, span) {
                        var key = $(span).data('key'),
                            value = transformed[key];
                        if (typeof value != "undefined") {
                            $(span).text("(" + value.count + ", " + value.pMin + ")");
                        } else {
                            $(span).text("(n/a)");
                        }
                    });
                }

                function toMap(aggs) {
                    var obj = {};
                    $.each(aggs, function(i, agg) {
                        obj[agg.key] = {
                            count: agg.count,
                            pMin: agg.pMin
                        }
                    });
                    return obj;
                }

                function ofInterest(elems, hist) {
                    return elems.filter(function(e) {
                        return hist.has(e);
                    }).map(function(e) {
                        return e.toLowerCase();
                    });
                }

                function histogramm(counts, numResultsTotal) {
                    var hist = [];
                    $.each(counts, function(i, kv) {
                        var p = 100 * kv.count / numResultsTotal;
                        if (globals.search.filter(p))
                            hist.push(kv.key);

                    });
                    return new Set(hist);
                }

                function mark(val, percentiles, predicate) {
                    var perc = math.pmax(val, percentiles);
                    if (predicate(perc)) return {
                        p: perc
                    };
                }

                function render(type, id, values, name) {
                    var options = $("#" + id);
                    if (type === "radio") {
                        options.append($('<div class="radio"><label><input type="radio" value="" name="' + name + '">Any</label></div>'));
                    }
                    $.each(values, function(index, item) {
                        var input = $('<input type="' + type + '">').attr("name", name).val(item.i);

                        options.append(
                            $('<div class="' + type + '">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)
                                        .append(document.createTextNode(" "))
                                        .append($("<span>").data('key', item.i))));
                    });
                }
            });
        </script>
    </head>

    <body>
        <form id="search-form">
            <input type="hidden" name="_raw" value="1">
            <input type="hidden" name="vc" value="Car">

            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <input type="radio" name="con" value=""> Any
                            <input type="radio" name="con" value="USED"> Used
                            <input type="radio" name="con" value="NEW"> New
                        </div>

                        <div class="form-group">
                            <label for="select-makes">Make</label>
                            <select name="mk" id="select-makes">
                                <option value="">Any</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="select-models">Model</label>
                            <select name="md" id="select-models">
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="pw">Power</label>
                            <input id="pw" type="text" name="pw">
                        </div>

                        <div class="form-group">
                            <label for="p">Price</label>
                            <input id="p" name="p" type="text">
                        </div>

                        <div id="checkboxes">
                            <div class="form-group">
                                <span class="chartable" data-chart="category">Categories</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-categories" aria-expanded="false"></span>
                                <div class="collapse" id="form-categories" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="fuel">Fuels</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-fuels" aria-expanded="false"></span>
                                <div class="collapse" id="form-fuels" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="climatisation">Climatisation</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-climatisations" aria-expanded="false"></span>
                                <div class="collapse" id="form-climatisations" aria-expanded="false" style="height: 0px;">
                                </div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="gear">Gears</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-gears" aria-expanded="false"></span>
                                <div class="collapse" id="form-gears" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span class="chartable" data-chart="color">Colors</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-colors" aria-expanded="false"></span>
                                <div class="collapse" id="form-colors" aria-expanded="false" style="height: 0px;"></div>
                            </div>

                            <div class="form-group">
                                <span>Park Assists</span>
                                <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-park-assists" aria-expanded="false"></span>
                                <div class="collapse" id="form-park-assists" aria-expanded="false" style="height: 0px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                      <!-- Nav tabs -->
                      <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#search-tab" role="tab" data-toggle="tab">Search</a></li>
                        <li role="presentation"><a href="#chart-tab" role="tab" data-toggle="tab">Charts</a></li>
                        <li role="presentation"><a href="#settings-tab" role="tab" data-toggle="tab">Settings</a></li>
                      </ul>

                      <!-- Tab panes -->
                      <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="search-tab">
                            <div id="nav-top">
                               <nav>
                                  <ul class="pager">
                                    <li class="previous"><a href="#"><span aria-hidden="true">&larr;</span> Previous</a></li>
                                    <li class="badge" id="num-search-results"></li>
                                    <li><span id="sort-order" class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span></li>
                                    <li class="next"><a href="#">More <span aria-hidden="true">&rarr;</span></a></li>
                                  </ul>
                                </nav>
                            </div>
                            <div id="search-result"></div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="chart-tab">
                            <div id="ft-chart"></div>
                            <div id="ft-chart"></div>
                            <div id="c-chart"></div>
                            <div id="clim-chart"></div>
                            <div id="gear-chart"></div>
                            <div id="color-chart"></div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="settings-tab">
                            <div>
                                <label for="page-range">
                                    Page scope: <span class="range"></span><div id="page-range" style="width:300px; margin:15px"></div>
                                </label>
                            </div>
                            <div>
                                <label for="search-range">
                                    Search scope:<span class="range"></span><div id="search-range" style="width:300px; margin:15px"></div>
                                </label>
                            </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <span class="chartable" data-chart="feature">Features</span>
                            <span class="glyphicon glyphicon-collapse-down pull-right collapsed" aria-hidden="true" data-toggle="collapse" data-target="#form-features" aria-expanded="false"></span>
                            <div class="collapse" id="form-features" aria-expanded="false" style="height: 0px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    </body>
</html>