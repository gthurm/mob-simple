<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

        <script src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load('visualization', '1.0', {'packages':['corechart']});</script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.1.3/mustache.min.js"></script>


        <script id="item-tmpl" type="x-tmpl-mustache">
            <div class="row">
                <div class="col-md-12"><h4>{{makeName}} {{modelDescription}}</h4></div>
            </div>
            <div class="row">
                <div class="col-md-6">{{location.country}}-{{location.zipCode}} {{location.city}}</div>
            <!-- <div class="col-md-6">{{#firstImageUrl}}<img src="http://{{firstImageUrl}}_28.JPG">{{/firstImageUrl}}</div> -->
                <div class="col-md-6"><strong>{{priceConsumerGross}} EUR</strong></div>
            </div>
            <div class="row">
                <div class="col-md-12">
                {{#powerKw}}{{powerKw}}kW ({{fv.pw}}){{/powerKw}}
                {{#mileage}}{{mileage}}km ({{fv.ml}}){{/mileage}}
                {{#cubicCapacity}}{{cubicCapacity}}ccm ({{fv.cc}}){{/cubicCapacity}}
                </div>
            </div>
        </script>


        <script type="text/javascript">
            $(function() {

                var itemTemplate = $("#item-tmpl").html();
                Mustache.parse(itemTemplate);

                $.ajax({
                    url: "http://m.mobile.de/svc/r/makes/Car",
                })
                .done(function(data) {
                    var options = $("#select-makes");
                    $.each(data.makes, function(index, make) {
                        options.append($("<option />").val(make.i).text(make.n));
                    });
                });

                $.ajax({
                    url: "http://m.mobile.de/svc/r/Car?_lang=en",
                })
                .done(function(data) {
                    renderCheckBox("#form-categories", data.categories, "c");
                    renderCheckBox("#form-fuels", data.fuels, "ft");
                    renderCheckBox("#form-gears", data.gears, "tr");
                    renderCheckBox("#form-colors", data.colors, "ecol");
                    renderRadioBox("#form-climatisations", data.climatisations, "clim");
                });


                $(document).on("change", "#search-form :input", function(event) {
                    doSearch();
                    event.preventDefault();
                });

                doSearch();

                function doSearch() {
                    var q, search, stats;

                    q =  $("#search-form :input").filter(function(index, element) {
                                return $(element).val() != "";
                    }).serializeArray();

                    search = $.ajax({
                        url: "http://m.mobile.de/svc/s",
                        data: q
                    });

                    stats = $.ajax({
                        url: "http://m.mobile.de/svc/s?psz=0&aggs=c,ft,pw,cc,ml",
                        data: q
                    });

                    $.when(search, stats).done(function(r1, r2) {
                        handleSearch(r1[0], r2[0]);
                        handleStats(r2[0]);
                    });

                    function handleSearch(res, stats) {
                        $("#num-search-results").text(res.numResultsTotal);
                        var div = $("#search-result").empty();

                        $.each(res.items, function(index, item) {
                            item.fv = {
                                pw: max(item.powerKw, stats.aggregations.pw),
                                ml: min(item.mileage, stats.aggregations.ml),
                                cc: max(item.cubicCapacity, stats.aggregations.cc)
                            }
                            div.append($("<div />").html(Mustache.render(itemTemplate, item)));
                        });
                    }

                    function handleStats(response) {
                        var aggs = response.aggregations;
                        // pieChart("c-chart",  "catgeory", aggs.c);
                        // pieChart("ft-chart", "fuel",     aggs.ft);
                        // barChart("p-chart",  "price",    aggs.p);
                        // barChart("pw-chart", "power",    aggs.pw);
                    }
                }

                function toArray(v) {
                    var key = Object.keys(v)[0];
                    return [key, v[key]];
                }

                function max(val, percentiles) {
                    if (percentiles)
                        return percentiles.map(toArray).reduce(function(p, c, i, a) {
                            return val >= c[1]  ? c[0] : p;
                        }, undefined);
                }

                function min(val, percentiles) {
                    if (percentiles)
                        return percentiles.map(toArray).reduce(function(p, c, i, a) {
                            return val <= c[1] ? p : c[0];
                        }, undefined);
                }

                function renderCheckBox(id, values, name) {
                    var options = $(id);
                    $.each(values, function(index, item) {
                        var input = $('<input type="checkbox">').attr("name", name).val(item.i);
                        options.append(
                            $('<div class="checkbox">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)));
                    });
                }

                function renderRadioBox(id, values, name) {
                    var options = $(id);
                    $.each(values, function(index, item) {
                        var input = $('<input type="radio">').attr("name", name).val(item.i);
                        options.append(
                            $('<div class="radio">')
                                .append(
                                    $('<label>')
                                        .append(input)
                                        .append(item.n)));
                    });
                }

                function pieChart(id, name, values) {
                    var chart = new google.visualization.PieChart(document.getElementById(id));
                    chart.draw(makeTable(name, values, function(v) {
                        return [v.key, v.count];
                    }));
                }

                function barChart(id, name, values) {
                    var chart = new google.visualization.BarChart(document.getElementById(id));
                    chart.draw(makeTable(name, values,  function(v) {
                        var key = Object.keys(v)[0];
                        return [key + "%", v[key]];
                    }));
                }

                function makeTable(name, values, mapFn) {
                    var data = new google.visualization.DataTable();
                    data.addColumn("string", name);
                    data.addColumn("number", "#");
                    data.addRows(values.map(mapFn));
                    return data;
                }

            });
        </script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <form id="search-form">
                        <input type="hidden" name="_raw" value="1">
                        <input type="hidden" name="vc" value="Car">

                        <div class="form-group">
                            <input type="radio" name="con" value="">Any
                            <input type="radio" name="con" value="USED">Used
                            <input type="radio" name="con" value="NEW">New
                        </div>


                        <div class="form-group">
                            Make
                            <select name="mk" id="select-makes">
                                <option value="">Any</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="pw">Power</label>
                            <input id="pw" type="text" name="pw">
                        </div>

                        <div class="form-group">
                            <label for="p">Price</label>
                            <input id="p" name="p" type="text">
                        </div>

                        <div id="form-categories" class="form-group">
                            Categories
                        </div>

                        <div id="form-fuels" class="form-group">
                            Fuels
                        </div>

                        <div id="form-gears" class="form-group">
                            Gears
                        </div>

                        <div id="form-colors" class="form-group">
                            Exterior colors
                        </div>

                        <div id="form-climatisations" class="form-group">
                            Climatisations
                        </div>
                    </form>
                </div>
                <div class="col-md-8">
                    <div id="charts">
                        <div id="ft-chart"></div>
                        <div id="c-chart"></div>
                        <div id="p-chart"></div>
                        <div id="pw-chart"></div>
                    </div>
                    <div id="search-result-head"><h4>Results <span id="num-search-results" class="badge"></span></h4></div>
                    <div id="search-result" class="container-fluid"></div>
                </div>
            </div>
        </div>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    </body>
</html>